"""Adicionar campos norma_tecnica e item separados

Revision ID: 53c316573303
Revises: b74f33730e1a
Create Date: 2025-07-01 13:01:45.031789

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = '53c316573303'
down_revision: Union[str, Sequence[str], None] = 'b74f33730e1a'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # Adicionar colunas como nullable primeiro
    op.add_column('perguntas', sa.Column('norma_tecnica', sa.String(length=50), nullable=True))
    op.add_column('perguntas', sa.Column('item', sa.String(length=50), nullable=True))
    
    # Popular os novos campos a partir do campo norma_artigo existente
    # Assumindo formato "NT-XX - Y.Y.Y"
    connection = op.get_bind()
    connection.execute(sa.text("""
        UPDATE perguntas 
        SET 
            norma_tecnica = SPLIT_PART(norma_artigo, ' - ', 1),
            item = SPLIT_PART(norma_artigo, ' - ', 2)
        WHERE norma_artigo IS NOT NULL AND norma_artigo != ''
    """))
    
    # Definir valores padrão para registros que não seguem o padrão
    connection.execute(sa.text("""
        UPDATE perguntas 
        SET 
            norma_tecnica = COALESCE(norma_tecnica, 'NT-00'),
            item = COALESCE(item, '0.0.0')
        WHERE norma_tecnica IS NULL OR item IS NULL
    """))
    
    # Tornar as colunas obrigatórias
    op.alter_column('perguntas', 'norma_tecnica', nullable=False)
    op.alter_column('perguntas', 'item', nullable=False)
    
    # Criar índices
    op.create_index(op.f('ix_perguntas_item'), 'perguntas', ['item'], unique=False)
    op.create_index(op.f('ix_perguntas_norma_tecnica'), 'perguntas', ['norma_tecnica'], unique=False)


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index(op.f('ix_perguntas_norma_tecnica'), table_name='perguntas')
    op.drop_index(op.f('ix_perguntas_item'), table_name='perguntas')
    op.drop_column('perguntas', 'item')
    op.drop_column('perguntas', 'norma_tecnica')
    # ### end Alembic commands ###
